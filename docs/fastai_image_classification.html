---

title: Build your custom image classifier using FastAI and WML-CE

keywords: fastai
sidebar: home_sidebar



---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: FastAI/01_fastai_image_classification.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This notebook was copied and modified for this lab from this source <a href="https://github.com/fastai/course-v3">https://github.com/fastai/course-v3</a></p>
<p>Welcome to lesson 1! For those of you who are using a Jupyter Notebook for the first time, you can learn about this useful tool in a tutorial we prepared specially for you; click <code>File</code>-&gt;<code>Open</code> now and click <code>00_notebook_tutorial.ipynb</code>.</p>
<p>In this lesson we will build our first image classifier from scratch, and see if we can achieve world-class results. Let's dive in!</p>
<p>Every notebook starts with the following three lines; they ensure that any edits to libraries you make are reloaded here automatically, and also that any charts or images displayed are shown in this notebook.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">reload_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># For Using GPU&#39;s</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="About-our-Class-Environment">About our Class Environment<a class="anchor-link" href="#About-our-Class-Environment"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We import all the necessary packages. We are going to work with the <a href="http://www.fast.ai/2018/10/02/fastai-ai/">fastai V1 library</a> which sits on top of <a href="https://hackernoon.com/pytorch-1-0-468332ba5163">Pytorch 1.3</a>. The fastai library provides many useful functions that enable us to quickly and easily build neural networks and train our models.</p>
<p>For this class, we are using WML-CE running in the Worldwide Client Experience Center Cloud, or CECC for short.  To access and environment, simply browse to this website and request a Power8 or Power9 environment.</p>
<p><a href="https://www.ibm.com/it-infrastructure/services/cecc-portal/web/Catalog">https://www.ibm.com/it-infrastructure/services/cecc-portal/web/Catalog</a></p>
<ul>
<li>Note : To get PowerAI up and running we have a special setup script in our github repo ... </li>
</ul>
<p><a href="https://github.ibm.com/vanstee/aicoc-ai-immersion/blob/master/FastAI/setup_fastai.sh">https://github.ibm.com/vanstee/aicoc-ai-immersion/blob/master/FastAI/setup_fastai.sh</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="nprint" class="doc_header"><code>nprint</code><a href="https://github.ibm.com/aicoc-ai-immersion/fastai_utils/tree/master/fastai_utils/utils.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>nprint</code>(<strong><code>mystring</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Project-Configuration">Project Configuration<a class="anchor-link" href="#Project-Configuration"> </a></h2><p>This data structure below will hold all the settings for our class.  Its handy to have a simple dictionary contain all your project settings to keep organized.  We have include an override capability to these default settings so that you can customize your project.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">getconfig</span><span class="p">(</span><span class="n">cfg_in</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;bs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;image_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/home/cecuser/FastAI/images&quot;</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cars&quot;</span><span class="p">,</span><span class="s2">&quot;busses&quot;</span><span class="p">,</span><span class="s2">&quot;trucks&quot;</span><span class="p">]</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;num_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="s2">&quot;valid&quot;</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span><span class="s2">&quot;test&quot;</span><span class="p">:</span><span class="mi">20</span><span class="p">}</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;d_partitions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;num_images&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>                 
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;jpeginfo&quot;</span><span class="p">]</span> <span class="o">=</span><span class="s2">&quot;/home/cecuser/aicoc-ai-immersion/FastAI/jpeginfo&quot;</span>
    <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;repo_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/home/cecuser/aicoc-ai-immersion/FastAI&quot;</span>    
   
    <span class="c1"># overwrite configs if passed</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cfg_in</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Overriding Config </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">v</span><span class="p">))</span>
        <span class="n">cfg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">cfg</span>

<span class="c1"># bs = 16   # uncomment this line if you run out of memory even after clicking Kernel-&gt;Restart</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Looking-at-the-data">Looking at the data<a class="anchor-link" href="#Looking-at-the-data"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here we are going to build our own dataset !!  Think of 3 categories you would like to classify images.  In this example, we will use</p>
<ul>
<li>busses</li>
<li>trucks </li>
<li>cars</li>
</ul>
<p>We will use an open source tool called <em>googliser</em> to download our images from google images.</p>
<p>For a Covid-19 based example you could make your classes something like</p>
<ul>
<li>"people wearing masks"</li>
<li>"people posing street"</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#################################################################################################</span>
<span class="c1"># @@ Students : Customize this cell with your custom classes for image classification</span>
<span class="c1">################################################################################################</span>

<span class="c1"># Overrides for lab</span>

<span class="n">mycfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;classes&quot;</span><span class="p">:[</span><span class="s2">&quot;people wearing masks&quot;</span><span class="p">,</span><span class="s2">&quot;people posing street&quot;</span><span class="p">,</span><span class="s2">&quot;people skateboarding&quot;</span><span class="p">,</span><span class="s2">&quot;people on bikes&quot;</span><span class="p">],</span>  <span class="c1">## &lt;&lt;- CLASS Enter your search terms here </span>
    <span class="s2">&quot;d_partitions&quot;</span><span class="p">:[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">cfg</span><span class="o">=</span><span class="n">getconfig</span><span class="p">(</span><span class="n">mycfg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Make-Some-Directories-to-hold-our-data">Make Some Directories to hold our data<a class="anchor-link" href="#Make-Some-Directories-to-hold-our-data"> </a></h2><p>FastAI is very flexible and help you label your image data in all sorts of ways.  You might have a bunch of images and a csv file with the labels.  You might have your images organized by folder with the folder name being the labels.</p>
<p>To see all the supported methods check out this link..
<a href="https://docs.fast.ai/vision.data.html#ImageDataBunch.from_folder">https://docs.fast.ai/vision.data.html#ImageDataBunch.from_folder</a></p>
<p>For our class, we are going to organize our data by folder.</p>
<p>TODO : insert image here ...</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Helpers to make directories</span>
<span class="k">def</span> <span class="nf">class_folder_name</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">d_part</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">return</span> <span class="n">base</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">d_part</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">makeDirIfNotExist</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>  
        <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Making directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> 
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> already exists .. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>

<span class="c1"># Build directory hierarchy</span>
<span class="c1">#   [train|valid|test ]</span>
<span class="c1">#    -----------------&gt; [class1 | class2 | class...]</span>
<span class="k">for</span> <span class="n">d_part</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;d_partitions&quot;</span><span class="p">]</span> <span class="p">:</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="p">:</span>
        <span class="n">directory</span><span class="o">=</span><span class="n">class_folder_name</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">],</span><span class="n">d_part</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">makeDirIfNotExist</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install-Googliser-here.">Install Googliser here.<a class="anchor-link" href="#Install-Googliser-here."> </a></h2><p>This handy utility will download our images from google images.  We will clone the repo from git.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># install googliser</span>
<span class="k">def</span> <span class="nf">install_googliser</span><span class="p">():</span>
    <span class="n">googliser_directory</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/googliser&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">googliser_directory</span><span class="p">):</span>  
        <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Installing Googliser here : </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">googliser_directory</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">])</span>
        <span class="o">!</span>git clone https://github.com/teracow/googliser
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Googliser already installed here : </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">googliser_directory</span><span class="p">))</span>

    <span class="n">googliser</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/googliser/googliser.sh&quot;</span>

    <span class="k">return</span> <span class="n">googliser</span> 
<span class="n">googliser</span> <span class="o">=</span> <span class="n">install_googliser</span><span class="p">()</span>
<span class="o">!</span>ls <span class="o">{</span>googliser<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-many-images-should-we-grab-?">How many images should we grab ?<a class="anchor-link" href="#How-many-images-should-we-grab-?"> </a></h2><p>Luckily not too many.. it always depends on the project, but we are going to use a pre-training deep learning network when we perform training.  Since that network was already trained on over 1 million images, we don't need to supply too many for our task.  This is why transfer learning is so powerful!</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;num_images&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The code below will download files to train folder only to avoid duplicate downloads.  </span>
<span class="c1"># We then move a few files over.  This can be done manually or programatically.  For our example</span>
<span class="c1"># we will let FastAI do the work for us!</span>

<span class="k">def</span> <span class="nf">download_images</span><span class="p">(</span><span class="n">cfg</span><span class="p">):</span>
    <span class="n">utility_dir</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;repo_dir&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">d_p</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;d_partitions&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="c1"># train only for now ..</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span><span class="n">class_folder_name</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">],</span><span class="n">d_p</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span>
            <span class="c1">#os.chdir(current_dir)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">utility_dir</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">googliser</span> <span class="o">+</span> \
                      <span class="s2">&quot; --o </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_dir</span><span class="p">)</span> <span class="o">+</span>\
                      <span class="s2">&quot; --phrase </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">+</span> \
                      <span class="s2">&quot; --parallel 50 --upper-size 500000 --lower-size 2000 &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot; -n </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;num_images&#39;</span><span class="p">][</span><span class="n">d_p</span><span class="p">])</span> <span class="o">+</span> \
                      <span class="s2">&quot; --format jpg --timeout 15 --safesearch-off &quot;</span>
            <span class="n">nprint</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="o">!{</span>command<span class="o">}</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Downloads complete!&quot;</span><span class="p">)</span>
<span class="n">download_images</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

<span class="c1"># This will take ~5 mins depending on how many classes / images we are grabbing... </span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Clean-up-downloaded-images-that-are-not-proper-jpeg-format-..">Clean up downloaded images that are not proper jpeg format ..<a class="anchor-link" href="#Clean-up-downloaded-images-that-are-not-proper-jpeg-format-.."> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># clean with jpeginfo! </span>
<span class="k">def</span> <span class="nf">clean_up_bad_jpegs</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="n">extension</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">])</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Search for Error files in </span><span class="si">{}</span><span class="s2">......&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">]))</span>
    <span class="c1"># handle both jpg //jpeg</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;find . -name </span><span class="se">\&quot;</span><span class="s2">*.</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span> <span class="o">+</span> \
      <span class="s2">&quot; | xargs -i </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;jpeginfo&quot;</span><span class="p">])</span> <span class="o">+</span> \
      <span class="s2">&quot; -c </span><span class="si">{}</span><span class="s2"> | grep ERROR&quot;</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Running command : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
    <span class="o">!{</span>command<span class="o">}</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Removing any error files listed above&quot;</span><span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="s1">&#39; | cut -d &quot; &quot; -f1 | xargs -i rm </span><span class="si">{}</span><span class="s1"> &#39;</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Running command : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
    <span class="o">!{</span>command<span class="o">}</span>
    <span class="n">nprint</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>

<span class="n">clean_up_bad_jpegs</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="s2">&quot;jpg&quot;</span><span class="p">)</span>
<span class="n">clean_up_bad_jpegs</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="s2">&quot;jpeg&quot;</span><span class="p">)</span>
<span class="c1"># find . -name &quot;*.jpg,&quot; | xargs -i ./jpeginfo -c {}</span>
<span class="c1"># find . -name &quot;*.jpg&quot; | xargs -i ./jpeginfo -c {} | grep ERROR | cut -d &quot; &quot; -f1 | xargs -i rm {}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#path = untar_data(URLs.PETS); path</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span><span class="o">.</span><span class="n">ls</span><span class="p">()</span>
<span class="c1">#cfg[&#39;image_dir&#39;]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first thing we do when we approach a problem is to take a look at the data. We <em>always</em> need to understand very well what the problem is and what the data looks like before we can figure out how to solve it. Taking a look at the data means understanding how the data directories are structured, what the labels are and what some sample images look like.</p>
<p>The main difference between the handling of image classification datasets is the way labels are stored. In this particular dataset, labels are stored in the filenames themselves. We will need to extract them to be able to classify the images into the correct categories. Fortunately, the fastai library has a handy function made exactly for this, <code>ImageDataBunch.from_name_re</code> gets the labels from the filenames using a <a href="https://docs.python.org/3.6/library/re.html">regular expression</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-Data-Bunch">Create Data Bunch<a class="anchor-link" href="#Create-Data-Bunch"> </a></h2><p>Fastai has a number of methods to create a data bunch. Lets look at some of the documentation using <strong>doc</strong> function</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#doc(ImageDataBunch)</span>
<span class="n">doc</span><span class="p">(</span><span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_folder</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># https://docs.fast.ai/vision.data.html#ImageDataBunch.from_folder</span>
<span class="c1">## Important, batch size should be set lower than the number of images you have</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">],</span>
                <span class="n">train</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span><span class="n">no_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">bs</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;bs&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">imagenet_stats</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>
<span class="c1">#data.show_batch(figsize=(4,4))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">label_list</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">classes</span><span class="p">),</span><span class="n">data</span><span class="o">.</span><span class="n">c</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training:-resnet34">Training: resnet34<a class="anchor-link" href="#Training:-resnet34"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we will start training our model. We will use a <a href="http://cs231n.github.io/convolutional-networks/">convolutional neural network</a> backbone and a fully connected head with a single hidden layer as a classifier. Don't know what these things mean? Not to worry, we will dive deeper in the coming lessons. For the moment you need to know that we are building a model which will take images as input and will output the predicted probability for each of the categories (in this case, it will have 37 outputs).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#create learner</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># save pretrained model ..</span>
<span class="n">learn</span><span class="o">.</span><span class="n">model</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># dont worry about the #na#, as long as we get a plot in the next section, great!</span>
<span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span> <span class="c1"># num_it=36, stop_div=False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Run 5 epochs (can do more if still getting better train / val)</span>
<span class="c1"># FILL IN THE RANGE BASE ON YOUR LRFIND RESULT</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">5e-5</span><span class="p">,</span><span class="mf">1e-2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Results">Results<a class="anchor-link" href="#Results"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see what results we have got.</p>
<p>We will first see which were the categories that the model most confused with one another. We will try to see if what the model predicted was reasonable or not. In this case the mistakes look reasonable (none of the mistakes seems obviously naive). This is an indicator that our classifier is working correctly.</p>
<p>Furthermore, when we plot the confusion matrix, if we can see that the distribution is heavily skewed: the model makes the same mistakes over and over again but it rarely confuses other categories. This suggests that it just finds it difficult to distinguish some specific categories between each other; this is normal behaviour.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>

<span class="n">losses</span><span class="p">,</span><span class="n">idxs</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">top_losses</span><span class="p">()</span>

<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">doc</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_top_losses</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">11</span><span class="p">),</span><span class="n">heatmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
<span class="n">interp</span><span class="o">.</span><span class="n">confusion_matrix</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">most_confused</span><span class="p">(</span><span class="n">min_val</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Unfreezing,-fine-tuning,-and-learning-rates">Unfreezing, fine-tuning, and learning rates<a class="anchor-link" href="#Unfreezing,-fine-tuning,-and-learning-rates"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since our model is working as we expect it to, we will <em>unfreeze</em> our model and train some more.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1&#39;</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#learn.save(&#39;stage-2&#39;)</span>
<span class="c1">#learn.load(&#39;stage-1&#39;);</span>
<span class="c1">#learn.unfreeze(-2)</span>
<span class="c1">#learn.fit_one_cycle(2, max_lr=slice(1e-6,1e-3))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>

<span class="n">losses</span><span class="p">,</span><span class="n">idxs</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">top_losses</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
<span class="n">interp</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's a pretty accurate model!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training:-resnet50">Training: resnet50<a class="anchor-link" href="#Training:-resnet50"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we will train in the same way as before but with one caveat: instead of using resnet34 as our backbone we will use resnet50 (resnet34 is a 34 layer residual network while resnet50 has 50 layers. It will be explained later in the course and you can learn the details in the <a href="https://arxiv.org/pdf/1512.03385.pdf">resnet paper</a>).</p>
<p>Basically, resnet50 usually performs better because it is a deeper network with more parameters. Let's see if we can achieve a higher performance here. To help it along, let's us use larger images too, since that way the network can see more detail. We reduce the batch size a bit since otherwise this larger network will require more GPU memory.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Optional-Assignment">Optional Assignment<a class="anchor-link" href="#Optional-Assignment"> </a></h2><p>Can you redo the training above with a different pre-trained model ???  See this page for some ideas</p>
<p><a href="https://docs.fast.ai/vision.models.html">https://docs.fast.ai/vision.models.html</a></p>
<ul>
<li>Hint : in a a code cell type  models.\&lt;&lt;tab&gt;&gt;</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">doc</span><span class="p">(</span><span class="n">cnn_learner</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#learn = cnn_learner(data, FILL_IN_HERE!!, metrics=error_rate)</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">vgg11_bn</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
<span class="c1"># model.alexnet</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># 2 epochs ...</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;stage-1-custom&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Lets-continue-to-tune-...">Lets continue to tune ...<a class="anchor-link" href="#Lets-continue-to-tune-..."> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1e-4</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If it doesn't get better results, you can always go back to your previous model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stage-1-50&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">interp</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">interp</span><span class="o">.</span><span class="n">most_confused</span><span class="p">(</span><span class="n">min_val</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Advanced-Example-:--Loading-Data-from-PAIV-/-IVI">Advanced Example :  Loading Data from PAIV / IVI<a class="anchor-link" href="#Advanced-Example-:--Loading-Data-from-PAIV-/-IVI"> </a></h1><p>So you want to train on some data that maybe you labelled in another tool ?  No problem.  Here we show how you could read in data exported from PAIV and classifying in this tool ...</p>
<p>For our IBM Visual Insights Example, we can just run a nice utility to reformat the output.  For convenience, we added a <strong>Bananas Dataset</strong> to our repo to play with ..</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;repo_dir&quot;</span><span class="p">])</span>
<span class="o">!</span>ls *.zip
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Unzip-our-bananas-data-and-convert-to-images-in-sub-directories">Unzip our bananas data and convert to images in sub-directories<a class="anchor-link" href="#Unzip-our-bananas-data-and-convert-to-images-in-sub-directories"> </a></h2><p>When you export data from IVI, you get a single zip file.  When you unzip this file, you get a singular directory with a metadata file called prop.json.  We have a utility that will read that prop.json and create a new directory with sorted images... lets see how this works</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># unzip the Bananas.zip to /tmp/bananas_ivi directory</span>
<span class="o">!</span>sudo yum install -y unzip
<span class="o">!</span>unzip -o -d /tmp Bananas.zip 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Now run our handy script !</span>
<span class="o">!</span>git clone https://github.com/dustinvanstee/powerai-vision-utils.git
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>conda install -y scikit-learn # dependency to run our utility ..
<span class="o">!</span>python powerai-vision-utils/reorganize_exported_dataset.py --directory_in /tmp/Bananas --directory_out /tmp/bananas_fastai/train
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls /tmp/bananas_fastai/train
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># New project config!</span>
<span class="n">mycfg</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;image_dir&quot;</span> <span class="p">:</span> <span class="s2">&quot;/tmp/bananas_fastai&quot;</span><span class="p">,</span>
    <span class="s2">&quot;classes&quot;</span><span class="p">:[</span><span class="s2">&quot;black&quot;</span><span class="p">,</span><span class="s2">&quot;green&quot;</span><span class="p">,</span><span class="s2">&quot;overripe&quot;</span><span class="p">,</span><span class="s2">&quot;yellows&quot;</span><span class="p">],</span>  <span class="c1">## &lt;&lt;- CLASS Enter your search terms here </span>
    <span class="s2">&quot;d_partitions&quot;</span><span class="p">:[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">ivicfg</span><span class="o">=</span><span class="n">getconfig</span><span class="p">(</span><span class="n">mycfg</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># New Image Path ..</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ivicfg</span><span class="p">[</span><span class="s2">&quot;image_dir&quot;</span><span class="p">])</span>
<span class="n">path</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls /tmp/bananas_fastai/black
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Define-Databunch">Define Databunch<a class="anchor-link" href="#Define-Databunch"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define some transforms and setup data bunch</span>
<span class="n">tfms</span> <span class="o">=</span> <span class="n">get_transforms</span><span class="p">(</span><span class="n">do_flip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">train</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="n">ds_tfms</span><span class="o">=</span><span class="n">tfms</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.20</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Display some images</span>
<span class="n">data</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Training">Training<a class="anchor-link" href="#Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Setup a CNN learner</span>
<span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet18</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Learning rate search</span>
<span class="n">learn</span><span class="o">.</span><span class="n">lr_find</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Run fit one cycle for 5 epochs</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span><span class="mf">3e-2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Lets see how well we did ... </span>
<span class="n">interp</span> <span class="o">=</span> <span class="n">ClassificationInterpretation</span><span class="o">.</span><span class="n">from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">losses</span><span class="p">,</span><span class="n">idxs</span> <span class="o">=</span> <span class="n">interp</span><span class="o">.</span><span class="n">top_losses</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">valid_ds</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
<span class="n">interp</span><span class="o">.</span><span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Inference">Inference<a class="anchor-link" href="#Inference"> </a></h1>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Download some sample images here .... </span>
<span class="n">command</span> <span class="o">=</span> <span class="n">googliser</span> <span class="o">+</span> \
                      <span class="s2">&quot; --o /tmp/banana_inference &quot;</span><span class="o">+</span>\
                      <span class="s2">&quot; --phrase </span><span class="se">\&quot;</span><span class="s2">ripe black yellow green bananas</span><span class="se">\&quot;</span><span class="s2"> &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot; --parallel 50 --upper-size 500000 --lower-size 2000 &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot; -n 10 &quot;</span> <span class="o">+</span> \
                      <span class="s2">&quot; --format jpg --timeout 15 --safesearch-off &quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
<span class="o">!{</span>command<span class="o">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># get rid of malformed images manually .</span>

<span class="n">command</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;jpeginfo&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; -c /tmp/banana_inference&quot;</span>
<span class="o">!{</span>command<span class="o">}</span>

<span class="c1">#!ls /tmp/banana_inference</span>
<span class="c1">#!rm /tmp/banana_inference/image\(0020\).jpg</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Inference on your list of images .. </span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;/tmp/banana_inference/image*.jpg&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">single_inference</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="p">:</span>
    
    <span class="n">img</span> <span class="o">=</span> <span class="n">open_image</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">prediction</span><span class="o">=</span><span class="n">learn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1">#print(prediction)</span>
    <span class="n">img_cls</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="n">prediction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()]</span>
    <span class="n">img</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">img_cls</span><span class="p">)</span>

<span class="k">for</span> <span class="n">my_img</span> <span class="ow">in</span> <span class="n">files</span> <span class="p">:</span>
    <span class="n">single_inference</span><span class="p">(</span><span class="n">my_img</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Congratulations, you can now build a pretty darn good classifier in less than one hour!</p>
<p>Credits</p>
<ul>
<li>FastAI Team</li>
<li>Bob Chesebrough / Dustin VanStee - AICoC Data science team</li>
</ul>

</div>
</div>
</div>
</div>
 

